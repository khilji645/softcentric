{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Internal Messaging</h3>

<div class="row" style="height: 75vh;">
  
  <!-- Inbox Panel -->
  <div class="col-md-4 border-end overflow-auto" style="height:100%; background:#f8f9fa;" id="inbox-panel">
    <h5 class="p-2">Inbox</h5>
    {% if conversations %}
    <ul class="list-group list-group-flush" id="inbox-list">
      {% for user, msgs in conversations.items() %}
      {% set unread_count = msgs | selectattr("receiver", "equalto", current_user) 
                                    | selectattr("read", "equalto", false) | list | length %}
      <li class="list-group-item d-flex justify-content-between align-items-center 
                 {% if user == selected_user %}active{% endif %}">
        <a href="{{ url_for('chat_with', receiver=user) }}" class="{% if unread_count>0 %}fw-bold{% endif %}">
          {{ user }}
        </a>
        {% if unread_count > 0 %}
        <span class="badge bg-primary rounded-pill" data-user="{{ user }}">{{ unread_count }}</span>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="p-2">No messages yet.</p>
    {% endif %}
  </div>

  <!-- Chat Panel -->
  <div class="col-md-8 d-flex flex-column" style="height:100%;">
    
    <!-- Conversation Area -->
    <div class="flex-grow-1 overflow-auto p-3" style="background:#f5f5f5;" id="chat-box">
      {% if conversation %}
        {% for msg in conversation %}
        <div class="mb-2 d-flex {% if msg.sender == current_user %}justify-content-end{% else %}justify-content-start{% endif %}">
          <div class="p-2 rounded {{ 'bg-primary text-white' if msg.sender == current_user else 'bg-light' }}" style="max-width:70%;">
            <div>{{ msg.message }}</div>
            <small class="text-muted">{{ msg.timestamp }}</small>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">Select a conversation or start a new one.</p>
      {% endif %}
    </div>

    <!-- New Message Form -->
    {% if selected_user %}
    <form method="POST" action="{{ url_for('chat_with', receiver=selected_user) }}" class="d-flex p-2 border-top" id="chat-form">
      <input type="text" name="message" class="form-control me-2" placeholder="Type your message..." required autocomplete="off">
      <button class="btn btn-success"><i class="bi bi-send"></i> Send</button>
    </form>
    {% endif %}

    <!-- Start New Conversation -->
    <div class="p-2 border-top bg-light">
      <form method="POST" action="{{ url_for('send_message') }}" class="d-flex gap-2">
        <select name="receiver" class="form-select" required>
          <option value="">Select user...</option>
          {% for user in all_users %}
            {% if user.username != current_user %}
              <option value="{{ user.username }}">{{ user.username }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <input type="text" name="message" class="form-control" placeholder="Type your message..." required autocomplete="off">
        <button class="btn btn-primary"><i class="bi bi-send"></i> Send</button>
      </form>
    </div>

  </div>
</div>

<!-- Optional: auto-scroll to bottom -->
<script>
  const chatBox = document.getElementById('chat-box');
  if(chatBox){
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Polling for updated inbox counts
  function updateInbox() {
    fetch('{{ url_for("unread_details") }}')
      .then(res => res.json())
      .then(data => {
        const inboxList = document.getElementById('inbox-list');
        if(!inboxList) return;

        inboxList.querySelectorAll('li').forEach(li => {
          const user = li.querySelector('a').textContent.trim();
          const badge = li.querySelector('span');
          const unreadCount = data.unread.filter(msg => msg.sender === user).length;

          if(unreadCount > 0){
            if(badge){
              badge.textContent = unreadCount;
            } else {
              const newBadge = document.createElement('span');
              newBadge.className = 'badge bg-primary rounded-pill';
              newBadge.dataset.user = user;
              newBadge.textContent = unreadCount;
              li.appendChild(newBadge);
            }
            li.querySelector('a').classList.add('fw-bold');
          } else {
            if(badge) badge.remove();
            li.querySelector('a').classList.remove('fw-bold');
          }
        });
      });
  }

  setInterval(updateInbox, 5000);
</script>
{% endblock %}
