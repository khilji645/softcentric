{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Chat with {{ receiver }}</h3>

<!-- Chat messages area -->
<div class="border p-3 mb-3 rounded shadow-sm flex-grow-1 overflow-auto" 
     style="height:400px; background:#f5f5f5;" id="chat-box">
  {% for msg in conversation %}
    {% set ts = msg.get("timestamp", "N/A") %}
    <div class="d-flex mb-2 {% if msg.sender == username %}justify-content-end{% else %}justify-content-start{% endif %}">
      <div class="p-2 rounded {{ 'bg-primary text-white' if msg.sender == username else 'bg-light' }}" 
           style="max-width:70%;">
        <div>{{ msg.message }}</div>
        <small class="text-muted">{{ ts[:16] }}</small>
      </div>
    </div>
  {% endfor %}
  {% if not conversation %}
    <p class="text-muted">No messages yet. Start the conversation below.</p>
  {% endif %}
</div>

<!-- New message form -->
<form method="POST" class="d-flex gap-2" id="chat-form">
  <input type="text" name="message" class="form-control" placeholder="Type your message..." required autocomplete="off">
  <button class="btn btn-success"><i class="bi bi-send"></i> Send</button>
</form>

<a href="{{ url_for('messages') }}" class="btn btn-link mt-2"><i class="bi bi-arrow-left"></i> Back to Inbox</a>

<!-- Auto-scroll to bottom -->
<script>
  const chatBox = document.getElementById('chat-box');
  if(chatBox){
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Optional: Auto-scroll when sending a new message
  const chatForm = document.getElementById('chat-form');
  chatForm?.addEventListener('submit', () => {
    setTimeout(() => {
      chatBox.scrollTop = chatBox.scrollHeight;
    }, 50);
  });
</script>

{% endblock %}
